# AGENTS

This file guides agentic contributors working in this repository.
Scope: entire repo (no nested overrides). Keep changes minimal and aligned with existing patterns.

## Quick Commands

- Install deps: `bun install`
- Generate CLI stubs: `bun run generate` (writes `.bunli/commands.gen.*`)
- Dev entry (watch + inspect): `bun run dev`
- Build bundle: `bun run build` (outputs to `dist/`)
- Release (tag + publish via bunli): `bun run release`
- Type-check only: `bun run typecheck`
- Test all: `bun test`
- Test single file: `bun test src/commands/branch.test.ts`
- Test by name pattern: `bun test -t "branch command"`
- Test watch: `bun test --watch`
- Lint/check: `bun x ultracite check` (oxlint)
- Auto-fix/format: `bun x ultracite fix`
- Diagnose lint setup: `bun x ultracite doctor`

## Environment & Generated Assets

- Tooling assumes Bun; `package.json` uses `types: ["bun"]`.
- ESM project (`type: "module"`). Use `import`/`export`; avoid CommonJS.
- CLI metadata is generated by `bunli`; never hand-edit `.bunli/commands.gen.*`.
- Build outputs live in `dist/`; do not edit committed artifacts.
- Default config example: `wt.config.json` at repo root.

## Project Structure (High Level)

- `src/index.ts`: CLI bootstrap; registers generated commands and preprocesses args.
- `src/commands/*`: Command handlers (`branch`, `init`, `pr`, `prune`, `remove`).
- `src/utils/*`: Shared helpers (errors, validators, prompts, copy/prepare, list).
- `src/config/*`: Config types and loader.
- `src/git/*`: Thin wrappers over Git commands and parsing.
- `.bunli/commands.gen.*`: Auto-generated command metadata consumed by `src/index.ts`.
- `wt.config.json`: Example default config consumed by `loadConfig`.

## Testing Guidance

- Runner: Bun test (patterns set in `bunli.config.ts`: `**/*.test.ts`, `**/*.spec.ts`).
- Prefer targeted runs (`bun test path/to/file.test.ts`) or name filter (`bun test -t "name"`).
- Keep tests fast and deterministic; avoid network/IO beyond Git command mocks.
- Coverage is enabled in config; keep output stable.

## Linting & Formatting (Ultracite / oxlint)

- Primary lint/format: `bun x ultracite check` / `bun x ultracite fix`.
- Run `check` before shipping; run `fix` to auto-apply formatting and common lint fixes.
- `doctor` is available if lint tooling misbehaves.
- oxlint is strict: expect type-safety, unused cleanup, and modern JS patterns enforced.

## Coding Style

- Language: TypeScript with `strict`; avoid `any` (prefer `unknown` with narrowing).
- Imports: group packages first, then locals. Keep tidy; no enforced sorter. Use explicit `.js` extension only when importing compiled outputs.
- Exports: prefer named exports; use index barrels (`src/utils/index.ts`, `src/git/index.ts`) when convenient.
- Mutability: default to `const`; use `let` only when necessary; never `var`.
- Functions: keep small and single-purpose; extract helpers over deep nesting; favor early returns.
- Types: prefer interfaces for objects (`RepoInfo`, `WtConfig`); add explicit return types on exported functions.
- Strings: mixed quotes allowed; stay consistent within a file (commonly single quotes). Use template literals over concatenation.
- Semicolons: generated files include them; source files mostly omit—match surrounding style.
- Nullish checks: use explicit guards; avoid relying on truthiness of numbers/booleans.
- Async: use `async/await`; avoid unhandled promises.
- Errors: throw `WtError` for user-facing failures and `WtWarning` for soft blocks. Reuse `handleError` plus `formatError`/`formatWarning`/`formatSuccess` for consistent output.
- Logging: `console.log` with concise, actionable messages. Keep user-facing copy short.
- Branch naming: enforce `branch` command rules—reject spaces/control chars, disallow `..`, leading/trailing `/`, `.lock`, and special chars.
- Git calls: use Bun's `$` template; call `.quiet()` when output is not needed. Avoid shell spawning unless required.
- File IO: prefer async (`Bun.file`, `fs.promises`); keep paths explicit. Do not rely on `wt.config.json` values in tests without isolating.
- Config: use `loadConfig()` and `getWorktreePath()`; merge defaults carefully to align with `DEFAULT_CONFIG`.
- CLI options: validate with `zod` via `@bunli/core` option schemas where possible.
- Prompts: use helpers in `src/utils/prompts.ts`; default to safe choices and confirm destructive actions.

## Command Authoring Patterns

- Define commands with `defineCommand` from `@bunli/core`; export default modules from `src/commands/*`.
- Handlers should follow flow: input validation → git/query operations → side effects → formatted output.
- Prefer early exits on invalid input; avoid deeply nested conditionals.
- For new commands, add under `src/commands/`, then run `bun run generate` to refresh `.bunli/commands.gen.*`.

## Git Interaction Expectations

- Use `src/git/git.ts` helpers for raw commands (rev-parse, branch listing, worktree listing).
- Normalize refs with `normalizeBranch`; treat HEAD-detached states carefully.
- Guard against ongoing operations (`merge`, `rebase`, `cherry-pick`) via repo info before destructive actions.
- Use `isBranchCheckedOut` to prevent duplicate worktree checkouts.

## UX & Output

- Keep messages concise; prefer single-line outputs unless guidance is needed.
- Use formatted helpers for success/warning/error to stay consistent.
- When copying files or running prepare commands, report succinctly (see `branch` handler patterns).

## File Ownership & Safety

- Treat `dist/` and `.bunli/` as generated/read-only; regenerate rather than edit.
- Do not commit build artifacts or generated assets unless explicitly requested.
- Keep patches small and scoped to the task.
- When unsure, favor clarity and safety over cleverness.

## Workflow for Agents

- Skim relevant command or utility before editing to match style.
- After changes, run `bun run typecheck` and targeted `bun test ...` for the touched areas; add `bun x ultracite check` (or `fix` if formatting is needed).
- Document user-facing behavior changes in `README.md` when applicable.
- Keep PR/patch size small; follow conventional commits if contributing upstream.

## Support

- Primary maintainer: @trungung (see repository URL in `package.json`).
- If new tooling (formatter/linter) is introduced, update this file with exact commands and scopes.
